name: Deploy Docker Compose

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Obtendo cÃ³digo
        uses: actions/checkout@v3

      - name: ğŸ³ Enviando arquivos para a VPS e subindo containers
        uses: cross-the-world/ssh-pipeline@master
        env:
          WELCOME: "ssh pipeline"
        with:
          host: ${{ secrets.SSH_HOST }}
          user: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          connect_timeout: 10s
          script: |
            echo "ğŸ‘‰ Criando diretÃ³rio destino"
            mkdir -p /var/www/app/docker

            echo "ğŸ‘‰ Removendo conteÃºdo antigo"
            rm -rf /var/www/app/docker/*

            echo "ğŸ‘‰ Enviando pasta docker/"
            upload "./docker/*" "/var/www/app/docker/"

            echo "ğŸ‘‰ Subindo containers"
            cd /var/www/app/docker
            docker compose down || true
            docker compose up -d --build

            echo "âœ… Deploy finalizado!"
